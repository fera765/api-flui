import { test, expect } from '../fixtures/console-capture';
import { MCPLogAnalyzer, MCPPageHelper } from '../fixtures/mcp-helpers';

test.describe('Valida√ß√£o do Trigger de Webhook', () => {
  test('deve criar automa√ß√£o, adicionar webhook trigger e verificar configura√ß√µes', async ({ pageWithLogging, capturedLogs }) => {
    const helper = new MCPPageHelper(pageWithLogging);
    
    console.log('üìç Navegando para p√°gina de automa√ß√µes...');
    await pageWithLogging.goto('http://localhost:8080/automations');
    await helper.waitForAppReady();
    
    // Capturar screenshot da p√°gina inicial
    await helper.captureScreenshot('automations-page-initial');
    
    console.log('üìç Procurando bot√£o de criar automa√ß√£o...');
    // Tentar encontrar bot√£o de criar nova automa√ß√£o
    const createButtons = [
      'button:has-text("Nova Automa√ß√£o")',
      'button:has-text("Criar Automa√ß√£o")',
      'button:has-text("Nova")',
      'button:has-text("Criar")',
      'button:has-text("New Automation")',
      '[data-testid="create-automation"]',
      'a[href*="create"]',
      'button[aria-label*="criar"]',
      'button[aria-label*="nova"]'
    ];
    
    let createButton = null;
    for (const selector of createButtons) {
      try {
        createButton = await pageWithLogging.$(selector);
        if (createButton && await createButton.isVisible()) {
          console.log(`‚úÖ Bot√£o encontrado: ${selector}`);
          break;
        }
      } catch (e) {
        // Continuar tentando
      }
    }
    
    if (!createButton) {
      console.log('‚ö†Ô∏è  Bot√£o de criar n√£o encontrado. Listando todos os bot√µes...');
      const allButtons = await pageWithLogging.$$('button');
      console.log(`üìä Total de bot√µes na p√°gina: ${allButtons.length}`);
      
      for (let i = 0; i < Math.min(allButtons.length, 10); i++) {
        const text = await allButtons[i].textContent();
        const ariaLabel = await allButtons[i].getAttribute('aria-label');
        console.log(`  Button ${i}: "${text}" [aria-label: ${ariaLabel}]`);
      }
      
      // Tentar clicar no primeiro bot√£o que pare√ßa ser de criar
      for (const btn of allButtons) {
        const text = (await btn.textContent())?.toLowerCase() || '';
        if (text.includes('criar') || text.includes('nova') || text.includes('new') || text.includes('+')) {
          console.log(`üéØ Tentando clicar em bot√£o com texto: "${text}"`);
          await btn.click();
          break;
        }
      }
    } else {
      console.log('üéØ Clicando no bot√£o de criar automa√ß√£o...');
      await createButton.click();
    }
    
    // Aguardar modal ou nova p√°gina
    await pageWithLogging.waitForTimeout(2000);
    await helper.captureScreenshot('after-click-create');
    
    console.log('üìç Procurando campos de formul√°rio...');
    // Procurar campos do formul√°rio
    const nameInput = await pageWithLogging.$('input[name="name"], input[placeholder*="nome"], input[placeholder*="name"], #name, #automation-name');
    const descInput = await pageWithLogging.$('textarea[name="description"], textarea[placeholder*="descri√ß√£o"], textarea[placeholder*="description"], #description');
    
    if (nameInput) {
      console.log('‚úÖ Campo de nome encontrado');
      await nameInput.fill('Teste Webhook Automation');
    } else {
      console.log('‚ö†Ô∏è  Campo de nome n√£o encontrado');
    }
    
    if (descInput) {
      console.log('‚úÖ Campo de descri√ß√£o encontrado');
      await descInput.fill('Automa√ß√£o de teste para validar webhook trigger');
    } else {
      console.log('‚ö†Ô∏è  Campo de descri√ß√£o n√£o encontrado');
    }
    
    // Procurar bot√£o de salvar/criar
    await pageWithLogging.waitForTimeout(1000);
    const saveButtons = await pageWithLogging.$$('button:has-text("Salvar"), button:has-text("Criar"), button:has-text("Save"), button:has-text("Create"), button[type="submit"]');
    
    if (saveButtons.length > 0) {
      console.log(`üìç Encontrados ${saveButtons.length} bot√µes de salvar/criar`);
      // Clicar no √∫ltimo bot√£o (geralmente √© o do modal)
      await saveButtons[saveButtons.length - 1].click();
      await pageWithLogging.waitForTimeout(2000);
      await helper.captureScreenshot('after-create-automation');
    } else {
      console.log('‚ö†Ô∏è  Bot√£o de salvar n√£o encontrado');
    }
    
    console.log('üìç Procurando √°rea do workflow/canvas...');
    // Aguardar o canvas do workflow aparecer
    await pageWithLogging.waitForTimeout(2000);
    
    // Verificar se h√° canvas do React Flow
    const canvas = await pageWithLogging.$('.react-flow, [data-testid="workflow-canvas"], .workflow-canvas');
    if (canvas) {
      console.log('‚úÖ Canvas do workflow encontrado');
    } else {
      console.log('‚ö†Ô∏è  Canvas do workflow n√£o encontrado');
    }
    
    await helper.captureScreenshot('workflow-canvas');
    
    console.log('üìç Procurando bot√£o de adicionar trigger/webhook...');
    // Procurar bot√£o de adicionar trigger ou ferramenta
    const addTriggerButtons = [
      'button:has-text("Trigger")',
      'button:has-text("Webhook")',
      'button:has-text("Adicionar Tool")',
      'button:has-text("Add Tool")',
      'button:has-text("+")',
      '[data-testid="add-tool"]',
      '[data-testid="add-trigger"]',
      'button[aria-label*="adicionar"]'
    ];
    
    let addTriggerBtn = null;
    for (const selector of addTriggerButtons) {
      try {
        addTriggerBtn = await pageWithLogging.$(selector);
        if (addTriggerBtn && await addTriggerBtn.isVisible()) {
          console.log(`‚úÖ Bot√£o de adicionar encontrado: ${selector}`);
          await addTriggerBtn.click();
          await pageWithLogging.waitForTimeout(1500);
          break;
        }
      } catch (e) {
        // Continuar
      }
    }
    
    if (!addTriggerBtn) {
      console.log('‚ö†Ô∏è  Bot√£o de adicionar trigger n√£o encontrado. Listando bot√µes vis√≠veis...');
      const visibleButtons = await pageWithLogging.$$('button:visible');
      for (let i = 0; i < Math.min(visibleButtons.length, 15); i++) {
        const text = await visibleButtons[i].textContent();
        console.log(`  Bot√£o ${i}: "${text}"`);
      }
    }
    
    await helper.captureScreenshot('after-click-add-trigger');
    
    console.log('üìç Procurando lista de tools/triggers dispon√≠veis...');
    // Procurar por lista de tools ou search
    const searchInput = await pageWithLogging.$('input[type="search"], input[placeholder*="busca"], input[placeholder*="search"], input[placeholder*="tool"]');
    if (searchInput) {
      console.log('‚úÖ Campo de busca encontrado');
      await searchInput.fill('webhook');
      await pageWithLogging.waitForTimeout(1000);
    }
    
    await helper.captureScreenshot('tool-search-webhook');
    
    // Procurar e clicar no webhook trigger
    console.log('üìç Procurando elemento WebHookTrigger para clicar...');
    const webhookOptions = [
      'text=WebHookTrigger',
      'text=Webhook Trigger',
      'text=webhook-trigger',
      '[data-tool="webhook-trigger"]',
      '[data-testid="tool-webhook-trigger"]',
      'button:has-text("WebHook")',
      'div:has-text("WebHookTrigger")',
      'div:has-text("Triggers automation via HTTP webhook")'
    ];
    
    let webhookOption = null;
    for (const selector of webhookOptions) {
      try {
        webhookOption = await pageWithLogging.$(selector);
        if (webhookOption && await webhookOption.isVisible()) {
          console.log(`‚úÖ Op√ß√£o Webhook encontrada: ${selector}`);
          await webhookOption.click();
          await pageWithLogging.waitForTimeout(2000);
          break;
        }
      } catch (e) {
        // Continuar
      }
    }
    
    if (!webhookOption) {
      console.log('‚ö†Ô∏è  Seletor direto n√£o funcionou. Procurando por qualquer elemento com "webhook"...');
      const allElements = await pageWithLogging.$$('div, button, span, a, [role="button"]');
      let found = false;
      for (let i = 0; i < allElements.length; i++) {
        const text = await allElements[i].textContent();
        if (text && (text.includes('WebHookTrigger') || text.includes('webhook-trigger'))) {
          console.log(`‚úÖ Encontrado elemento com webhook: "${text}"`);
          // Tentar clicar neste elemento
          try {
            await allElements[i].click();
            await pageWithLogging.waitForTimeout(2000);
            found = true;
            console.log('‚úÖ Click realizado com sucesso!');
            break;
          } catch (e) {
            console.log(`  Erro ao clicar: ${e.message}`);
            // Continuar
          }
        }
      }
      
      if (!found) {
        console.log('‚ùå N√£o foi poss√≠vel clicar no WebHookTrigger');
      }
    }
    
    await helper.captureScreenshot('after-select-webhook');
    
    console.log('üìç Aguardando o node ser adicionado ao canvas...');
    await pageWithLogging.waitForTimeout(2000);
    
    console.log('üìç Procurando o node WebHookTrigger no canvas para clicar...');
    // O node foi adicionado ao canvas, agora precisamos clicar nele para abrir o modal de configura√ß√£o
    const nodeSelectors = [
      '[data-id*="webhook"]',
      '[data-nodeid*="webhook"]',
      '.react-flow__node:has-text("WebHookTrigger")',
      '[class*="node"]:has-text("WebHookTrigger")',
      'div:has-text("WebHookTrigger")',
      '[data-testid="node-webhook-trigger"]'
    ];
    
    let nodeElement = null;
    for (const selector of nodeSelectors) {
      try {
        const elements = await pageWithLogging.$$(selector);
        for (const el of elements) {
          const text = await el.textContent();
          if (text && text.includes('WebHookTrigger')) {
            nodeElement = el;
            console.log(`‚úÖ Node encontrado com selector: ${selector}`);
            break;
          }
        }
        if (nodeElement) break;
      } catch (e) {
        // Continuar
      }
    }
    
    if (!nodeElement) {
      console.log('‚ö†Ô∏è  Procurando node por texto gen√©rico...');
      // Procurar por qualquer div/elemento que contenha WebHookTrigger
      const allNodes = await pageWithLogging.$$('.react-flow__node, [class*="node"], div[data-id], div[draggable="true"]');
      console.log(`üìä Total de nodes no canvas: ${allNodes.length}`);
      
      for (let i = 0; i < allNodes.length; i++) {
        const text = await allNodes[i].textContent();
        if (text && text.includes('WebHookTrigger')) {
          nodeElement = allNodes[i];
          console.log(`‚úÖ Node WebHookTrigger encontrado no √≠ndice ${i}`);
          break;
        }
      }
    }
    
    if (nodeElement) {
      console.log('‚úÖ Node WebHookTrigger encontrado! Agora procurando bot√£o Config...');
      
      // Procurar pelo bot√£o Config dentro do node
      const configButtonSelectors = [
        'button:has-text("Config")',
        'button:has(text()="Config")',
        '[class*="button"]:has-text("Config")'
      ];
      
      let configButton = null;
      for (const selector of configButtonSelectors) {
        try {
          // Procurar dentro do node element
          configButton = await nodeElement.$(selector);
          if (configButton) {
            console.log(`‚úÖ Bot√£o Config encontrado com selector: ${selector}`);
            break;
          }
        } catch (e) {
          // Continuar
        }
      }
      
      if (!configButton) {
        // Procurar globalmente por todos os bot√µes Config e pegar o que est√° pr√≥ximo do WebHookTrigger
        const allConfigButtons = await pageWithLogging.$$('button:has-text("Config")');
        console.log(`üìä Total de bot√µes Config encontrados na p√°gina: ${allConfigButtons.length}`);
        
        if (allConfigButtons.length > 0) {
          // Usar o √∫ltimo bot√£o Config (provavelmente o do node rec√©m adicionado)
          configButton = allConfigButtons[allConfigButtons.length - 1];
          console.log('‚úÖ Usando o √∫ltimo bot√£o Config encontrado');
        }
      }
      
      if (configButton) {
        console.log('üéØ Clicando no bot√£o Config...');
        await configButton.click();
        await pageWithLogging.waitForTimeout(2000);
        await helper.captureScreenshot('after-click-config-button');
      } else {
        console.log('‚ùå Bot√£o Config n√£o encontrado');
        // Tentar clicar no node mesmo assim
        console.log('üéØ Tentando clicar no node diretamente...');
        await nodeElement.click();
        await pageWithLogging.waitForTimeout(2000);
      }
    } else {
      console.log('‚ùå Node WebHookTrigger n√£o encontrado no canvas');
    }
    
    console.log('üìç Verificando se modal de configura√ß√£o abriu...');
    // Aguardar modal de configura√ß√£o aparecer
    await pageWithLogging.waitForTimeout(1000);
    
    // Procurar pelo modal
    const modals = [
      '[role="dialog"]',
      '.modal',
      '[data-radix-dialog-content]',
      '[data-testid="node-config-modal"]',
      '[data-testid="tool-config-modal"]'
    ];
    
    let modal = null;
    for (const selector of modals) {
      modal = await pageWithLogging.$(selector);
      if (modal && await modal.isVisible()) {
        console.log(`‚úÖ Modal encontrado: ${selector}`);
        break;
      }
    }
    
    if (!modal) {
      console.log('‚ö†Ô∏è  Modal de configura√ß√£o n√£o encontrado');
    }
    
    await helper.captureScreenshot('webhook-config-modal');
    
    console.log('üìç Procurando por URL do webhook e API key no modal...');
    
    // Capturar todo o conte√∫do do modal
    const modalContent = modal ? await modal.textContent() : await pageWithLogging.textContent('body');
    console.log('üìÑ Conte√∫do do modal/p√°gina:');
    console.log(modalContent);
    
    // Procurar por URL do webhook
    const urlPatterns = [
      /https?:\/\/[^\s<>"]+\/webhook\/[a-zA-Z0-9-]+/g,
      /Webhook URL[:\s]+([^\s<>"]+)/gi,
      /URL[:\s]+([^\s<>"]+)/gi
    ];
    
    let webhookUrl = null;
    for (const pattern of urlPatterns) {
      const match = modalContent?.match(pattern);
      if (match) {
        webhookUrl = match[0];
        console.log(`‚úÖ URL do webhook encontrada: ${webhookUrl}`);
        break;
      }
    }
    
    // Procurar por API Key
    const apiKeyPatterns = [
      /API Key[:\s]+([a-zA-Z0-9-_]+)/gi,
      /Key[:\s]+([a-zA-Z0-9-_]{20,})/gi,
      /[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}/gi // UUID pattern
    ];
    
    let apiKey = null;
    for (const pattern of apiKeyPatterns) {
      const match = modalContent?.match(pattern);
      if (match) {
        apiKey = match[0];
        console.log(`‚úÖ API Key encontrada: ${apiKey}`);
        break;
      }
    }
    
    // Procurar por elementos de input que possam conter a URL ou API key
    const inputs = await pageWithLogging.$$('input[readonly], input[disabled], input[type="text"]');
    console.log(`üìä Total de inputs encontrados: ${inputs.length}`);
    
    for (let i = 0; i < inputs.length; i++) {
      const value = await inputs[i].inputValue();
      const placeholder = await inputs[i].getAttribute('placeholder');
      const label = await inputs[i].getAttribute('aria-label');
      
      console.log(`  Input ${i}:`);
      console.log(`    Value: ${value}`);
      console.log(`    Placeholder: ${placeholder}`);
      console.log(`    Label: ${label}`);
      
      if (value && value.includes('http')) {
        webhookUrl = value;
        console.log(`‚úÖ URL do webhook encontrada no input: ${value}`);
      }
      
      if (value && value.length > 20 && !value.includes('http')) {
        apiKey = value;
        console.log(`‚úÖ API Key encontrada no input: ${value}`);
      }
    }
    
    // Verificar elementos com c√≥digo ou valor copi√°vel
    const codeElements = await pageWithLogging.$$('code, pre, [data-copy], [class*="code"]');
    console.log(`üìä Total de elementos de c√≥digo encontrados: ${codeElements.length}`);
    
    for (let i = 0; i < codeElements.length; i++) {
      const text = await codeElements[i].textContent();
      console.log(`  Code element ${i}: ${text}`);
      
      if (text && text.includes('http')) {
        webhookUrl = text;
      }
      if (text && text.length > 20 && !text.includes('http')) {
        apiKey = text;
      }
    }
    
    await helper.captureScreenshot('webhook-config-details');
    
    // An√°lise de logs
    const analyzer = new MCPLogAnalyzer(capturedLogs);
    console.log('\n' + analyzer.generateReport());
    
    // Verifica√ß√µes
    console.log('\nüìã RESULTADO DA VALIDA√á√ÉO:');
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    
    if (webhookUrl) {
      console.log(`‚úÖ URL do Webhook encontrada: ${webhookUrl}`);
    } else {
      console.log('‚ùå URL do Webhook N√ÉO foi encontrada no modal');
    }
    
    if (apiKey) {
      console.log(`‚úÖ API Key encontrada: ${apiKey}`);
    } else {
      console.log('‚ùå API Key N√ÉO foi encontrada no modal');
    }
    
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    
    // Se n√£o encontrou, falhar o teste mas com informa√ß√£o √∫til
    if (!webhookUrl || !apiKey) {
      console.log('\n‚ö†Ô∏è  ATEN√á√ÉO: URL do webhook e/ou API key n√£o foram encontradas!');
      console.log('Isso pode indicar que:');
      console.log('1. O modal n√£o carregou completamente');
      console.log('2. As informa√ß√µes est√£o em um formato diferente');
      console.log('3. H√° um problema no backend ao gerar essas informa√ß√µes');
      console.log('4. O frontend n√£o est√° renderizando esses dados corretamente');
    }
    
    // Verificar se houve erros cr√≠ticos
    expect(analyzer.hasCriticalErrors()).toBe(false);
  });
});
